---
title: "lagoa_plots_run245"
author: "Gabriel Mendes"
date: "22/03/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Carregando bibliotecas ----

```{r}
{
  library(adespatial)
  library(base)
  library(Biostrings)
  library(DECIPHER)
  library(factoextra)
  library(future)
  library(ggforce)
  library(ggh4x)
  library(ggord)
  library(ggplot2)
  library(ggpubr)
  library(ggvegan)
  library(Matrix)
  library(phyloseq)
  library(ShortRead)
  library(stringr)
  library(tibble)
  library(tidyr)
  library(vegan)
  library(dplyr)
}
```

# Caminhos ----
```{r}
{
  prjct_path <- "~/projetos/lagoa_ingleses/"
  results_path <- paste0(prjct_path,"/results")
  figs_path <- paste0(results_path,"/figuras")
  tbl_path <- paste0(prjct_path,"/tabelas/raw/run_2_4_5")
  prjct_radical <- "eDNA_Lagoa-dos-Ingleses"
}
```

# Obtencao dos dados ----
```{r}
{
  raw_results_tbl <- read.csv(paste0(tbl_path,"/","run_2_4_5_lagoa_ingleses_v2023.csv"), sep = ",", check.names = FALSE) %>% tibble()
  raw_results_tbl$`Curated ID`[raw_results_tbl$`Curated ID` %in% c("Oreochromis niloticus")] <- "Tilapia rendalli" # Oreochromis niloticus é Tilapia
}
```

# Paletas de cores ----
```{r}
{
  color <- grDevices::colors()[grep('gr(a|e)y', grDevices::colors(), invert = T)] # fonte: https://stackoverflow.com/questions/15282580/how-to-generate-a-number-of-most-distinctive-colors-in-r
  color2 <- c("#dc562a", # fonte: https://medialab.github.io/iwanthue/
              "#8e9fd9", 
              "#ca833f", 
              "#4d5a91", 
              "#cbcd9f", 
              "#2f2641", 
              "#d87d70", 
              "#313a25", 
              "#c94576", 
              "#4e7989", 
              "#8e3526", 
              "#d5acad", 
              "#591f2d", 
              "#550037", 
              "#8d6571",
              "#67d6b1", 
              "#6639c6", 
              "#6cda4e", 
              "#c24fd6", 
              "#c9db3e", 
              "#422478", 
              "#a7df83", 
              "#dc42ab", 
              "#519a40", 
              "#736dd8", 
              "#d9b647", 
              "#853a7d", 
              "#858438", 
              "#d48fce", 
              "#4e7b53", 
              "#db3c4e", 
              "#8acad8",
              "#4c8649",
              "#6e67b4",
              "#8f752d",
              "#b2523d",
              "#b04c7f")
}
```

# Tabela wider para NMDS, Beta Diversidade e PCA ----

# Essa tabela e uma matriz onde as linhas sao as amostras e as colunas sao as especies
# Cada valor representa a abundancia da especie na amostra. Essa matriz pode ser usada
# em diversas analises

# Para realizar as analises que envolvam apenas as abundancias das especies,
# usar as colunas de 4 a 35 c[,4:35]

## Tabela só peixes 
```{r}
{
  spp_sample_tbl_f <- raw_results_tbl %>%
    select(c(
      "Sample",
      # "Run",
      # "Group",
      "Expedition",
      # "Coleta",
      "Year",
      #"Sample.Name",
      #"File_name",
      # "OTU",
      # "Read_origin",
      "Curated ID",
      # "final ID",
      # "Abundance",
      # "Relative abundance to all samples",
      "Relative abundance on sample",
      # "Sample.total.abundance",
      # "Type",
      "Point")) %>%
    filter(!`Curated ID` %in% c("Actinopteri", ## tirando as ASVs que nao foram identificadas a nivel de especie, nao-peixes e NA
                                "Astyanax",
                                "Characidae",
                                "Characidium",
                                "Characiformes",
                                "Cichla",
                                "Cichlidae",
                                "Hoplias",
                                "Pimelodus",
                                "",
                                "Cutibacterium acnes",
                                "Bos taurus",
                                "Canis familiaris",
                                "Didelphis albiventris (Gamba)",
                                "Homo sapiens",
                                "Hydrochaeris hydrochaeris (Capivara)",
                                "Nannopterum brasilianus",
                                "Oryctolagus cuniculus (Coelho-bravo)",
                                "Progne chalybea (Andorinha-grande)",
                                "Sus scrofa"
                                )) %>%
    # filter(!Sample %in% c("LI1-neo-mi",
    #                       "L2_dez20",
    #                       "L2_nov20")
    #        ) %>%
    group_by(Sample,
             Expedition,
             Point,
             Year,
             `Curated ID`
             ) %>%
    summarize(`ID Abundance on sample (%)` = sum(`Relative abundance on sample`)
              ) %>%
    mutate(Sample = factor(Sample, levels = c("LI1-neo-mi",
                                              "L2_dez20",
                                              "L2_nov20",
                                              "L1_out21",
                                              "L1_nov21",
                                              "L2_out21",
                                              "L2_nov21",
                                              "L3_out21",
                                              "L3_nov21",
                                              "L4_out21",
                                              "L4_nov21"
                                              ))) %>%
    pivot_wider(names_from = `Curated ID`, ## especies nas colunas, samples nas linhas
                  values_from = `ID Abundance on sample (%)`) %>%
    # pivot_wider(names_from = Sample, ## especies nas linhas, samples nas colunas
                # values_from = `ID Abundance on sample (%)`) %>% 
    ungroup() %>%
    unique()
  
  ## substituindo NA por 0
  spp_sample_tbl_f[is.na(spp_sample_tbl_f)] = 0
  
  ## transformando a tabela em um data frame
  spp_sample_tbl_f <- as.data.frame(spp_sample_tbl_f) 
  
  # Sample como row.names
  row.names(spp_sample_tbl_f) <- spp_sample_tbl_f$Sample
  
  # Curated IDs como row.names
  # row.names(spp_sample_tbl_f) <- spp_sample_tbl_f$`Curated ID`
  
  # deletando Sample
  spp_sample_tbl_f <- spp_sample_tbl_f %>% select(-c(Sample))
  
  # deletando Curated ID
  # spp_sample_tbl_f <- spp_sample_tbl_f %>% select(-c(`Curated ID`))
}
```

## Tabela todas Ids a nível de especie
```{r}
{
  spp_sample_tbl_all <- raw_results_tbl %>%
    select(c(
      "Sample",
      # "Run",
      # "Group",
      "Expedition",
      # "Coleta",
      "Year",
      #"Sample.Name",
      #"File_name",
      # "OTU",
      # "Read_origin",
      "Curated ID",
      # "final ID",
      # "Abundance",
      # "Relative abundance to all samples",
      "Relative abundance on sample",
      # "Sample.total.abundance",
      # "Type",
      "Point")) %>%
    filter(!`Curated ID` %in% c("Actinopteri", ## tirando as ASVs que nao foram identificadas a nivel de especie, nao-peixes e NA
                                "Astyanax",
                                "Characidae",
                                "Characidium",
                                "Characiformes",
                                "Cichla",
                                "Cichlidae",
                                "Hoplias",
                                "Pimelodus",
                                "",
                                "Cutibacterium acnes"
    )) %>%
    # filter(!Sample %in% c("LI1-neo-mi",
    #                       "L2_dez20",
    #                       "L2_nov20")
    # ) %>% 
    group_by(Sample,
             #Expedition,
             #Point,
             #Year,
             `Curated ID`
    ) %>%
    summarize(`ID Abundance on sample (%)` = sum(`Relative abundance on sample`)
    ) %>%
    mutate(Sample = factor(Sample, levels = c("LI1-neo-mi",
                                              "L2_dez20",
                                              "L2_nov20",
                                              "L1_out21",
                                              "L1_nov21",
                                              "L2_out21",
                                              "L2_nov21",
                                              "L3_out21",
                                              "L3_nov21",
                                              "L4_out21",
                                              "L4_nov21"
    ))) %>%
    ungroup() %>%
    unique()  %>% 
    pivot_wider(names_from = Sample, 
                values_from = `ID Abundance on sample (%)`) %>% 
    ungroup() %>%
    unique()
  
  ## substituindo NA por 0
  spp_sample_tbl_all[is.na(spp_sample_tbl_all)] = 0
  
  ## transformando a tabela em um data frame
  spp_sample_tbl_all <- as.data.frame(spp_sample_tbl_all) 
  
  # Curated IDs como row.names
  row.names(spp_sample_tbl_all) <- spp_sample_tbl_all$`Curated ID`
  
  # deletando Curated ID
  spp_sample_tbl_all <- spp_sample_tbl_all %>% select(-c(`Curated ID`))
}
```

## Tabela todas amostras todas ids e samples
```{r}
{
  spp_sample_tbl_tudo <- raw_results_tbl %>%
    select(c(
      "Sample",
      # "Run",
      # "Group",
      "Expedition",
      # "Coleta",
      "Year",
      #"Sample.Name",
      #"File_name",
      # "OTU",
      # "Read_origin",
      "Curated ID",
      # "final ID",
      # "Abundance",
      # "Relative abundance to all samples",
      "Relative abundance on sample",
      # "Sample.total.abundance",
      # "Type",
      "Point")) %>%
    filter(!`Curated ID` %in% c("Actinopteri",
                                "Astyanax",
                                "Characidae",
                                "Characidium",
                                "Characiformes",
                                "Cichla",
                                "Cichlidae",
                                "Hoplias",
                                "Pimelodus",
                                "",
                                "Cutibacterium acnes"
                                )) %>% 
    group_by(Sample,
             #Expedition,
             #Point,
             #Year,
             `Curated ID`
    ) %>%
    summarize(`ID Abundance on sample (%)` = sum(`Relative abundance on sample`)
    ) %>%
    mutate(Sample = factor(Sample, levels = c("L1_out21",
                                              "L1_nov21",
                                              "L2_out21",
                                              "L2_nov21",
                                              "L3_out21",
                                              "L3_nov21",
                                              "L4_out21",
                                              "L4_nov21",
                                              "L2_dez20",
                                              "L2_nov20",
                                              "LI1-neo-mi"
    ))) %>%
    ungroup() %>%
    unique()  %>% 
    pivot_wider(names_from = Sample, 
                values_from = `ID Abundance on sample (%)`) %>% 
    ungroup() %>%
    unique()
  
  ## substituindo NA por 0
  spp_sample_tbl_tudo[is.na(spp_sample_tbl_tudo)] = 0
  
  ## transformando a tabela em um data frame
  spp_sample_tbl_tudo <- as.data.frame(spp_sample_tbl_tudo) 
  
  # Curated IDs como row.names
  row.names(spp_sample_tbl_tudo) <- spp_sample_tbl_tudo$`Curated ID`
  
  # deletando Curated ID
  spp_sample_tbl_tudo <- spp_sample_tbl_tudo %>% select(-c(`Curated ID`))
}
```

# Bar Plots Proporcao Especies/Ids ----

## Barplots com os resultados das proporcoes

## Utilizando a abundancia relativa nas amostras para calcular a proporcao de peixes
```{r}
{
  reads_tbl <- raw_results_tbl %>%
    select(c(
      "Sample",
      "Expedition",
      "Year",
      "Sample.Name",
      "File_name",
      "Curated ID",
      "Relative abundance to all samples",
      "Relative abundance on sample",
      "Point",
      "Abundance",
      "Sample total abundance"
    )) %>% 
    # filter(Expedition %in% c("Nov_Dec/20", "Dec/20", "Nov/20")) %>%
    mutate("Peixe" = if_else (`Curated ID` %in% c("",
                                                  "Cutibacterium acnes",
                                                  "Bos taurus",
                                                  "Canis familiaris",
                                                  "Didelphis albiventris (Gamba)",
                                                  "Homo sapiens",
                                                  "Hydrochaeris hydrochaeris (Capivara)",
                                                  "Nannopterum brasilianus",
                                                  "Oryctolagus cuniculus (Coelho-bravo)",
                                                  "Progne chalybea (Andorinha-grande)",
                                                  "Sus scrofa"),"FALSE", "TRUE")) %>%
    mutate("Especie" = if_else (`Curated ID` %in% c("Hoplias",
                                                    "Cichla",
                                                    "Actinopteri",
                                                    "Characiformes",
                                                    "Siluriformes",
                                                    "Astyanax",
                                                    "Characidium",
                                                    "Cichlidae",
                                                    "Characidae",
                                                    "Pimelodus"), "FALSE", "TRUE")) %>% 
    group_by(Peixe, Especie) %>% 
    summarize("Peixe" = unique(Peixe), #identificacao se as ASVs sao de peixes ou nao-peixes
              "Especie" = unique(Especie), #identificacao se as ASVs foram identificadas ao nivel de especie
              # `RRA` = sum(`Relative abundance on sample`)/11, #proporcao calculada com a RRA
              `Reads` = sum(`Abundance`), #numero de ASVs
              `Proporcao` = sum(`Reads` / 2730833 * 100) #proporcao calculada com o total de ASVs (sem filtrar)
    ) %>%
    ungroup()
}
```

## Proporcoes barplots
```{r}
{
  ### Proporcao de peixes 
  {peixe <- c("Não-peixes", "Peixes")
  reads <- c(25130, (160274 + 2545429))
  proporcao <- c(0.92, (5.87 + 93.21))
  peixes <- data_frame(peixe, ASVs, proporcao)
  }
  ## Barplots da proporcao de peixes
  {
    print(plot_peixe <- peixes %>% 
            ggplot(aes(x=peixe, y=proporcao, fill = peixe)) + 
            geom_bar(stat = "identity") +
            geom_text(aes(label = proporcao), ## colocar o valor da proporcao acima das barras
                      position = position_dodge(width = 0.9),
                      vjust = -0.1,
                      colour = "black", size = 6) +
            guides(col = guide_legend(nrow = 6)) +
            xlab("Espécies") + ## alterar o nome do eixo x
            ylab("Proporção de reads %") + ## alterar o nome do eixo y
            ggtitle(label = "Proporção de identificações associadas a peixes") + ## alterar o titulo do plot
            theme_bw(base_size = 16) +
            scale_fill_manual(values = viridis::viridis(n=4)[c(2,3)]) +
            guides(fill = guide_legend("")) + ## alterar o titulo da legenda
            theme(plot.title = element_text(hjust=0.3))
    )
    ## Plotando
    ggsave(plot = plot_peixe, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/agosto/barplots/plot_peixes.pdf",
           device = "pdf", units = "cm", height = 15, width = 15, dpi = 600)
  }
  
  ### Proporcao de ids
  especie <- c("Espécie", "Outros")
  e_reads <- c(2545429, 160274)
  e_proporcao <- c(0.94, 0.06)
  especies <- data_frame(especie, e_ASVs, e_proporcao)
  
  ## Barplots da proporcao de ids
  
  print(plot_ids <- grouped_by_ID_especie_tbl %>% 
          ggplot(aes(x = Especie, y = Proporcao, fill = Peixe)) + 
          geom_bar(stat = "identity") +
          geom_text(aes(label = Peixe), ## colocar o valor da proporcao acima das barras
                    position = position_dodge(width = 0.9),
                    vjust = -0.1,
                    colour = "black", size = 6) +
          guides(col = guide_legend(nrow = 6)) +
          xlab("Nível taxonômico") + ## alterar o nome do eixo x
          ylab("Proporção de reads %") + ## alterar o nome do eixo y
          ggtitle(label = "Proporção de identificações e \n respectivos níveis taxonômicos") + ## alterar o titulo do plot
          theme_bw(base_size = 16) +
          scale_fill_manual(values = viridis::viridis(n=4)[c(2,3)]) +
          guides(fill = guide_legend("Nível")) + ## alterar o titulo da legenda
          theme(plot.title = element_text(hjust=0.5)))
  
    ## Barplots da proporcao de ids
  
  print(plot_ids <- especies %>% 
          ggplot(aes(x = especie, y = e_proporcao, fill = especie)) + 
          geom_bar(stat = "identity") +
          geom_text(aes(label = e_proporcao), ## colocar o valor da proporcao acima das barras
                    position = position_dodge(width = 0.9),
                    vjust = -0.1,
                    colour = "black", size = 6) +
          guides(col = guide_legend(nrow = 6)) +
          xlab("Nível taxonômico") + ## alterar o nome do eixo x
          ylab("Proporção de reads %") + ## alterar o nome do eixo y
          ggtitle(label = "Proporção de identificações e \n respectivos níveis taxonômicos") + ## alterar o titulo do plot
          theme_bw(base_size = 16) +
          scale_fill_manual(values = viridis::viridis(n=4)[c(2,3)]) +
          guides(fill = guide_legend("Nível")) + ## alterar o titulo da legenda
          theme(plot.title = element_text(hjust=0.5))
  )
  ## Plotando
  ggsave(plot = plot_ids, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/agosto/barplots/plot_ids.pdf",
         device = "pdf", units = "cm", height = 15, width = 15, dpi = 600)
}
```


# Tile Plots ----

## Criacao das tabelas all_ids_tbl e few_ids_tbl
```{r}
{
  ## Criacao da lista com os possiveis nomes atribuidos as ASVs
  {
    raw_results_tbl %>% colnames()
    raw_results_tbl %>% colnames() %>% paste0(collapse = '",\n"') %>% cat()
  }
  
  ## Agrupamento da ASVs que possuem os mesmos atributos abaixo
  {
    grouped_by_ID_tbl <- raw_results_tbl %>%
      select(c(
        "Sample",
        "Expedition",
        "Year",
        "Sample.Name",
        "File_name",
        "Curated ID",
        "Relative abundance on sample",
        "Point"
      )) %>% 
      group_by(Sample, `Curated ID`, Expedition, Point, Sample.Name, File_name) %>% 
      summarize(`Sample` = unique(Sample),
                `Curated ID` = unique(`Curated ID`),
                `Expedition` = unique(Expedition),
                `Year` = unique(Year),
                `Point` = unique(Point),
                `Sample.Name` = unique(Sample.Name),
                `File_name` = unique(File_name),
                `RRA` = sum(`Relative abundance on sample`)) %>%
      ungroup()
  }
  
  ## Organizar as especies
  {
    grouped_by_ID_tbl$`Curated ID` %>% unique()%>% sort() %>%  paste0(collapse = '",\n"') %>% cat()
    grouped_by_ID_tbl$Sample %>% unique()%>% sort() %>%  paste0(collapse = '",\n"') %>% cat()
  }
  
  ## Organizar as ordem das especies usando fatores
  
  ### com todas as identificacoes
  {
    all_ID_tbl <- grouped_by_ID_tbl %>%
      mutate(`Curated ID` = factor(`Curated ID`,
                                   levels = rev(c(
                                     "",
                                     "Actinopteri",
                                     "Acinocheirodon melanogramma",
                                     "Astyanax",
                                     "Astyanax fasciatus",
                                     "Astyanax lacustris",
                                     "Brycon orthotaenia",
                                     "Bryconamericus stramineus",
                                     "Characidae",
                                     "Characidium",
                                     "Characiformes",
                                     "Cichla",
                                     "Cichlidae",
                                     "Colossoma macropomum",
                                     "Coptodon zillii",
                                     "Eigenmannia virescens",
                                     "Gymnotus carapo",
                                     "Hemigrammus gracilis",
                                     "Hemigrammus marginatus",
                                     "Hoplias",
                                     "Hoplias intermedius",
                                     "Hoplias malabaricus",
                                     "Hypomasticus steindachneri",
                                     "Leporellus vittatus",
                                     "Leporinus piau",
                                     "Leporinus reinhardti",
                                     "Leporinus taeniatus",
                                     "Megaleporinus elongatus",
                                     "Megaleporinus garmani",
                                     "Moenkhausia costae",
                                     "Myleus micans",
                                     "Oreochromis niloticus",
                                     "Orthospinus franciscensis",
                                     "Pimelodus",
                                     "Pimelodus fur",
                                     "Pimelodus maculatus",
                                     "Pimelodus pohli",
                                     "Planaltina myersi",
                                     "Poecilia reticulata",
                                     "Prochilodus costatus",
                                     "Pseudoplatystoma corruscans",
                                     "Pygocentrus piraya",
                                     "Rhamdia quelen",
                                     "Salmo salar",
                                     "Serrasalmus brandtii",
                                     "Tilapia rendalli",
                                     "Wertheimeria maculata",
                                     #nao-peixes
                                     "Bos taurus",
                                     "Canis familiaris",
                                     "Cavia magna",
                                     "Cutibacterium acnes",
                                     "Didelphis albiventris (Gamba)",
                                     "Homo sapiens",
                                     "Hydrochaeris hydrochaeris (Capivara)",
                                     "Nannopterum brasilianus",
                                     "Oryctolagus cuniculus (Coelho-bravo)",
                                     "Progne chalybea (Andorinha-grande)",
                                     "Sus scrofa"
                                   ))))
    }
  
  ### Sem os grupos alterado
  {
    few_ID_tbl <- grouped_by_ID_tbl %>% #ids apenas ao nivel de especie e sem a bacteria
      mutate(`Curated ID` = factor(`Curated ID`,
                                   levels = rev(c(
                                     "Hoplias intermedius",
                                     "Hoplias malabaricus",
                                     "Gymnotus carapo",
                                     "Salmo salar",
                                     "Acinocheirodon melanogramma",
                                     "Tilapia rendalli",
                                     "Brycon orthotaenia",
                                     "Prochilodus costatus",
                                     "Serrasalmus brandtii",
                                     "Megaleporinus garmani",
                                     "Leporellus vittatus",
                                     "Leporinus piau",
                                     "Hemigrammus gracilis",
                                     "Hemigrammus marginatus",
                                     "Astyanax fasciatus",
                                     "Astyanax lacustris",
                                     "Wertheimeria maculata",
                                     "Pimelodus fur",
                                     "Rhamdia quelen",
                                     "Planaltina myersi",
                                     "Bryconamericus stramineus",
                                     "Pseudoplatystoma corruscans",
                                     "Pimelodus maculatus",
                                     "Pimelodus pohli",
                                     "Leporinus taeniatus",
                                     "Leporinus reinhardti",
                                     "Eigenmannia virescens",      
                                     "Colossoma macropomum",
                                     "Myleus micans",
                                     "Pygocentrus piraya",
                                     "Orthospinus franciscensis",
                                     "Poecilia reticulata",
                                     #nao-peixes
                                     "Cavia magna",
                                     #"Cutibacterium acnes",
                                     "Bos taurus",
                                     "Canis familiaris",
                                     "Didelphis albiventris (Gamba)",
                                     "Homo sapiens",
                                     "Hydrochaeris hydrochaeris (Capivara)",
                                     "Nannopterum brasilianus",
                                     "Oryctolagus cuniculus (Coelho-bravo)",
                                     "Progne chalybea (Andorinha-grande)",
                                     "Sus scrofa"
                                   ))))
  }
  }
```

## Criacao do Tile Plot das amostras da Lagoa dos Ingleses sequenciadas nas corridas 2, 4 e 5

### Por ponto
```{r}
  ## Tile plot filtrando as ids
  {
    tile_ponto_few <- few_ID_tbl %>%
      mutate(Expedition = factor(Expedition)) %>% # transformando variaveis categoricas em fatores com niveis
      mutate(Sample = factor(Sample,
                             levels = c("L1_nov21",
                                        "L1_out21",
                                        "L2_nov21",
                                        "L2_out21",
                                        "L3_nov21",
                                        "L3_out21",
                                        "L4_nov21",
                                        "L4_out21",
                                        "L1-neo-mi",
                                        "L2 Dez/20",
                                        "L2 Nov/20"
                                        ))) %>%
      mutate(Expedition = factor(Expedition,
                                 levels = c("Nov_Dec/20",
                                            "Nov/20",
                                            "Dec/20",
                                            "out/21",
                                            "Nov/21"
                                            ))) %>%
      mutate(Point = factor(Point)) %>%
      mutate(File_name = factor(File_name)) %>%
      mutate(Expedition = factor(Expedition)) %>%
      # filter(RRA >= 0.01) %>% # retirando as ASVs "espurias", com abundancia menor que 0.01 ATUAL: Heron pediu para voltar com elas
      filter(!is.na(`Curated ID`)) %>%   # retirar os NA
      filter(Expedition %in% c("out/21", # deixando apenas as amostras de 2021
                               "Nov/21")) %>%
      ### Tile plot
      ggplot(aes(y = `Curated ID`, 
                 # x = Point,
                 x = Expedition,
                 fill = RRA
                 )) +
      geom_tile() +
      # geom_text(aes(label= RRA),
      geom_text(aes(label= sprintf("%0.2f", round(RRA, digits = 2))), # exibindo os valores de RRA dentro dos tiles para facilitar a discussao (opcional)
                    colour = "black", size = 3
                    ) +
        # facet_grid(~Expedition, # facetando por mes
      facet_grid(~Point, # facetando por ponto
                   scales = "free_x",
                   space = "free_x") +
      labs(fill ='Abundância \nrelativa (%)',
               x = "Amostras",
               y= "Espécies") +
      ggtitle(label = "Espécies identificadas em cada ponto") +
      geom_hline(yintercept = c(8.5)) + # linha que separa as especies de peixes e nao-peixes
      scale_fill_continuous(
        trans = "log10", # exibir a abundancia em escala logaritmica para favorecer a exibicao de baixo RRA
        breaks = c(0.001, 0.01, 0.1, 1, 10, 75), # definindo os valores que aparecem na escala
        type = "viridis") +
      theme(text=element_text(size = 10, face = "bold")) +
      guides(col = guide_legend(nrow = 6)) +
      theme_bw(base_size = 16) +
      theme(plot.title = element_text(hjust = 0.5))
      
      ## Plotando
      ggsave(plot = tile_ponto_few, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/setembro/tile_plots/tile_ponto_few.pdf",
           device = "pdf", units = "cm", height = 20, width = 30, dpi = 600)
}
  {# versão EBI
  print(tile_EBI <- few_ID_tbl %>%
          mutate(Expedition = factor(Expedition)) %>% # transformando variaveis categoricas em fatores com niveis
          mutate(Sample = factor(Sample,
                                 levels = c("L1_nov21",
                                            "L1_out21",
                                            "L2_nov21",
                                            "L2_out21",
                                            "L3_nov21",
                                            "L3_out21",
                                            "L4_nov21",
                                            "L4_out21",
                                            "L1-neo-mi",
                                            "L2 Dez/20",
                                            "L2 Nov/20"
                                            ))) %>%
          mutate(Expedition = factor(Expedition,
                                     levels = c("Nov_Dec/20",
                                                "Nov/20",
                                                "Dec/20",
                                                "out/21",
                                                "Nov/21"
                                                ))) %>%
          mutate(Point = factor(Point)) %>%
          mutate(File_name = factor(File_name)) %>%
          mutate(Expedition = factor(Expedition)) %>%
          filter(!is.na(`Curated ID`)) %>%   # retirar os NA
          filter(Expedition %in% c("out/21", # deixando apenas as amostras de 2021
                                   "Nov/21")) %>%
          filter(!`Curated ID` %in% c("Cavia magna", # Bela pediu para retirar essas especies
                                      "Bos taurus",
                                      "Canis familiaris",
                                      "Didelphis albiventris (Gamba)",
                                      "Homo sapiens",
                                      "Hydrochaeris hydrochaeris (Capivara)",
                                      "Nannopterum brasilianus",
                                      "Oryctolagus cuniculus (Coelho-bravo)",
                                      "Progne chalybea (Andorinha-grande)",
                                      "Sus scrofa")) %>%
          ### Tile plot
          ggplot(aes(y = `Curated ID`,
                     # x = Point,
                     x = Expedition,
                     fill = RRA
                     )) +
          geom_tile() +
          facet_grid(~Point, # facetando por ponto
                     scales = "free_x",
                     space = "free_x") +
          labs(fill ='Abundância \nrelativa (%)',
               x = "Amostras",
               y= "Espécies") +
          ggtitle(label = "Espécies identificadas em cada ponto") +
          #geom_hline(yintercept = c(8.5)) + # linha que separa as especies de peixes e nao-peixes
          scale_fill_continuous(
          trans = "log10", # exibir a abundancia em escala logaritmica para favorecer a exibicao de baixo RRA
          breaks = c(0.001, 0.01, 0.1, 1, 10, 75), # definindo os valores que aparecem na escala
          type = "viridis") +
          theme(text=element_text(size = 10, face = "bold")) +
          guides(col = guide_legend(nrow = 6)) +
          theme_bw(base_size = 16) +
          theme(plot.title = element_text(hjust = 0.5)))
    ## Plotando
    ggsave(plot = tile_EBI, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/setembro/tile_plots/tile_EBI.pdf",
           device = "pdf", units = "cm", height = 20, width = 30, dpi = 600)
}

{# versão EBI like com todas as amostras e não-peixes
  print(tile_EBI_all <- few_ID_tbl %>%
          mutate(Expedition = factor(Expedition)) %>% # transformando variaveis categoricas em fatores com niveis
          mutate(Sample = factor(Sample,
                                 levels = c("L1_nov21",
                                            "L1_out21",
                                            "L2_nov21",
                                            "L2_out21",
                                            "L3_nov21",
                                            "L3_out21",
                                            "L4_nov21",
                                            "L4_out21",
                                            "L1-neo-mi",
                                            "L2 Dez/20",
                                            "L2 Nov/20"
                                 ))) %>%
          mutate(Expedition = factor(Expedition,
                                     levels = c("Nov_Dec/20",
                                                "Nov/20",
                                                "Dec/20",
                                                "out/21",
                                                "Nov/21"
                                     ))) %>%
          mutate(Point = factor(Point)) %>%
          mutate(File_name = factor(File_name)) %>%
          mutate(Expedition = factor(Expedition)) %>%
          filter(!is.na(`Curated ID`)) %>%   # retirar os NA
          # filter(Expedition %in% c("out/21", # deixando apenas as amostras de 2021
          #                          "Nov/21")) %>%
          # filter(!`Curated ID` %in% c("Cavia magna", # Bela pediu para retirar essas especies
          #                             "Bos taurus",
          #                             "Canis familiaris",
          #                             "Didelphis albiventris (Gamba)",
          #                             "Homo sapiens",
          #                             "Hydrochaeris hydrochaeris (Capivara)",
          #                             "Nannopterum brasilianus",
          #                             "Oryctolagus cuniculus (Coelho-bravo)",
          #                             "Progne chalybea (Andorinha-grande)",
          #                             "Sus scrofa")) %>%
          ### Tile plot
          ggplot(aes(y = `Curated ID`,
                     # x = Point,
                     x = Expedition,
                     fill = RRA
          )) +
          geom_tile() +
          facet_grid(~Point, # facetando por ponto
                     scales = "free_x",
                     space = "free_x") +
          labs(fill ='Abundância \nrelativa (%)',
               x = "Amostras",
               y= "Espécies") +
          ggtitle(label = "Espécies identificadas em cada ponto (todas amostras, todas spp)") +
          geom_hline(yintercept = c(10.5)) + # linha que separa as especies de peixes e nao-peixes
          scale_fill_continuous(
            trans = "log10", # exibir a abundancia em escala logaritmica para favorecer a exibicao de baixo RRA
            breaks = c(0.001, 0.01, 0.1, 1, 10, 75), # definindo os valores que aparecem na escala
            type = "viridis") +
          theme(text=element_text(size = 10, face = "bold")) +
          guides(col = guide_legend(nrow = 6)) +
          theme_bw(base_size = 16) +
          theme(plot.title = element_text(hjust = 0.5)))
  ## Plotando
  ggsave(plot = tile_EBI_all, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/novembro/tile_plots/tile_EBI_all.pdf",
         device = "pdf", units = "cm", height = 20, width = 30, dpi = 600)
}

## Title plot exibindo todas as ids
  {
    tile_ponto_all <- all_ID_tbl %>%
      mutate(Expedition = factor(Expedition)) %>% # transformando variaveis categoricas em fatores com niveis
      mutate(Sample = factor(Sample,
                             levels = c("L1_nov21",
                                        "L1_out21",
                                        "L2_nov21",
                                        "L2_out21",
                                        "L3_nov21",
                                        "L3_out21",
                                        "L4_nov21",
                                        "L4_out21",
                                        "L1-neo-mi",
                                        "L2 Dez/20",
                                        "L2 Nov/20"
                                        ))) %>%
      mutate(Expedition = factor(Expedition,
                                 levels = c("Nov_Dec/20",
                                            "Nov/20",
                                            "Dec/20",
                                            "out/21",
                                            "Nov/21"
                                            ))) %>%
      mutate(Point = factor(Point)) %>%
      mutate(File_name = factor(File_name)) %>%
      mutate(Expedition = factor(Expedition)) %>%
      # filter(RRA >= 0.01) %>% # retirando as ASVs "espurias", com abundancia menor que 0.01 #exibindo todas as Ids, mesmo com RRA abaixo de 0.01
      # filter(!is.na(`Curated ID`)) %>%   # retirar os NA
      # filter(Expedition %in% c("out/21", # deixando apenas as amostras de 2021
      #                          "Nov/21")) %>%
      ### Tile plot
      ggplot(aes(y = `Curated ID`, 
                 # x = Point,
                 x = Expedition,
                 fill = RRA
                 )) +
      geom_tile() +
      geom_text(aes(label= sprintf("%0.2f", round(RRA, digits = 2)))) + # exibindo os valores de RRA dentro dos tiles para facilitar a discussao (opcional)
      # facet_grid(~Expedition, # facetando por mes
      facet_grid(~Point, # facetando por ponto
                 scales = "free_x",
                 space = "free_x") +
      labs(fill ='Abundância \nrelativa (%)',
           x = "Amostras",
           y = "Espécies") +
      ggtitle(label = "Espécies identificadas em cada ponto e mês (todas ids)") +
      geom_hline(yintercept = c(11.5)) +
      scale_fill_continuous(
        trans = "log10", # exibir a abundancia em escala logaritmica para favorecer a exibicao de baixo RRA
          breaks = c(0.001, 0.01, 0.1, 1, 10, 75), # definindo os valores que aparecem na escala
        type = "viridis") +
      theme(text=element_text(size = 14)) +
      guides(col = guide_legend(nrow = 6)) +
      theme(plot.title = element_text(hjust=0.5))
    
    ## Plotando
    ggsave(plot = tile_ponto_all, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/agosto/tile_plots/tile_ponto_all.pdf",
           device = "pdf", units = "cm", height = 25, width = 30, dpi = 600)
}
```

### Por Ano
```{r}
  ## Exibindo por ano filtrando ids
  {
    print(tile_ano_few <- few_ID_tbl %>%
      mutate(Expedition = factor(Expedition)) %>% #transformando variaveis categoricas em fatores com niveis
      mutate(Sample = factor(Sample,
                           levels = c("L1_nov21",
                                      "L1_out21",
                                      "L2_nov21",
                                      "L2_out21",
                                      "L3_nov21",
                                      "L3_out21",
                                      "L4_nov21",
                                      "L4_out21",
                                      "L1-neo-mi",
                                      "L2 Dez/20",
                                      "L2 Nov/20"
                           ))) %>%
      mutate(Expedition = factor(Expedition,
                               levels = c("Nov_Dec/20",
                                          "Nov/20",
                                          "Dec/20",
                                          "out/21",
                                          "Nov/21"
                               ))) %>%
      mutate(Point = factor(Point)) %>%
      mutate(File_name = factor(File_name)) %>%
      mutate(Expedition = factor(Expedition)) %>%
      filter(!`Curated ID` %in% c("Astyanax", #retirando as ids a nivel de genero
                              "Characidae",
                              "Cichlidae",
                              "Hoplias",
                              "Pimelodus")) %>%
      # filter(RRA >= 0.01) %>% #retirando as ASVs "espurias", com abundancia menor que 0.01 ATUAL. Heron pediu para voltar com essas 
      filter(!is.na(`Curated ID`)) %>% #retirar os NA
      ### Tile plot
      ggplot(aes(y = `Curated ID`, 
               x = Year,
               fill = RRA,
               )) +
      scale_x_continuous(breaks = 0:2100) +
      geom_tile() + 
      labs(fill='Abundância \nrelativa (%)',
           x = "Ano",
           y = "Espécies") +
      geom_hline(yintercept = c(10.5)) +
      scale_fill_continuous(
        trans = "log10", # exibir a abundancia em escala logaritmica para favorecer a exibicao de baixo RRA
        breaks = c(0.001, 0.01, 0.1, 1, 10, 75), # definindo os valores que aparecem na escala
        type = "viridis") +
      ggtitle(label = "Espécies identificadas por ano") +
      theme(text = element_text(size = 14)) +
      guides(col = guide_legend(nrow = 6)) +
      theme(plot.title = element_text(hjust = 0.5)
            ))
    
    ## Plotando
    ggsave(plot = tile_ano_few, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/setembro/tile_plots/tile_ano_few.pdf",
           device = "pdf", units = "cm", height = 25, width = 20, dpi = 600)
    }

  ## Exibindo  por ano com todas ids
  {
  tile_ano_all <- all_ID_tbl %>%
      mutate(Expedition = factor(Expedition)) %>% #transformando variaveis categoricas em fatores com niveis
      mutate(Sample = factor(Sample,
                             levels = c("L1_nov21",
                                        "L1_out21",
                                        "L2_nov21",
                                        "L2_out21",
                                        "L3_nov21",
                                        "L3_out21",
                                        "L4_nov21",
                                        "L4_out21",
                                        "L1-neo-mi",
                                        "L2 Dez/20",
                                        "L2 Nov/20"
                                        ))) %>%
      mutate(Expedition = factor(Expedition,
                                 levels = c("Nov_Dec/20",
                                            "Nov/20",
                                            "Dec/20",
                                            "out/21",
                                            "Nov/21"
                                            ))) %>%
      mutate(Point = factor(Point)) %>%
      mutate(File_name = factor(File_name)) %>%
      mutate(Expedition = factor(Expedition)) %>%
      # filter(!`Curated ID` %in% c("Astyanax", #retirando as ids a nivel de genero
      #                           "Characidae",
      #                           "Cichlidae",
      #                           "Hoplias",
      #                           "Pimelodus")) %>%
      # filter(RRA >=0.01) %>% #retirando as ASVs "espurias", com abundancia menor que 0.01 ATUAL. Heron pediu para manter as reads com baixa abundancia
      # filter(!is.na(`Curated ID`)) %>% #retirar os NA
      ### Tile plot
      ggplot(aes(y = `Curated ID`,
                 x = Year,
                 fill = RRA,
                 )) +
      scale_x_continuous(breaks = 0:2100) +
      geom_tile() +
      labs(fill='Abundância \nrelativa (%)',
           x = "Ano",
           y = "Espécies") +
      geom_hline(yintercept = c(11.5)) +
      scale_fill_continuous(
        trans = "log10", # exibir a abundancia em escala logaritmica para favorecer a exibicao de baixo RRA
        breaks = c(0.001, 0.01, 0.1, 1, 10, 75), # definindo os valores que aparecem na escala
        type = "viridis") +
        ggtitle(label = "Espécies identificadas por ano (todas ids)") +
        theme(text=element_text(size = 14)) +
        guides(col = guide_legend(nrow = 6)) +
        theme(plot.title = element_text(hjust=0.5))
    
    ## Plotando
    ggsave(plot = tile_ano_all, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/agosto/tile_plots/tile_ano_all.pdf",
           device = "pdf", units = "cm", height = 25, width = 20, dpi = 600)
    }

```

# Alfa diversidade Ponto/Mes ----
```{r}
  ## Especies
  {
  alpha_tbl <- raw_results_tbl %>%
    # filter(`Relative abundance on sample` >= 0.01) %>% # heron pediu para manter as ASVs espurias
    filter(!`Curated ID` %in% c("Actinopteri", ## tirando as ASVs que nao foram identificadas a nivel de especie, nao-peixes e NA
                                "Astyanax",
                                "Characidae",
                                "Characidium",
                                "Characiformes",
                                "Cichla",
                                "Cichlidae",
                                "Hoplias",
                                "Pimelodus",
                                "",
                                "Cavia magna",
                                "Cutibacterium acnes",
                                "Bos taurus",
                                "Canis familiaris",
                                "Didelphis albiventris (Gamba)",
                                "Homo sapiens",
                                "Hydrochaeris hydrochaeris (Capivara)",
                                "Nannopterum brasilianus",
                                "Oryctolagus cuniculus (Coelho-bravo)",
                                "Progne chalybea (Andorinha-grande)",
                                "Sus scrofa"
    )) %>%
    mutate("Mês" = str_split_fixed(string = .$Sample, # criando uma nova coluna quebrando as infos da coluna Sample
                                   pattern = "_",
                                   n = 2)[,2]) %>%
    mutate(Mês = factor(Mês, levels = c("out21",
                                        "nov21",
                                        "dez20",
                                        "nov20"))) %>%
    # filter(Expedition %in% c("out/21", # deixando apenas as amostras de 2021
    #                          "Nov/21")) %>%
    group_by(Sample,
             Read_origin,
             Primer,
             `Curated ID`,
             Year,
             Point,
             Expedition,
             Mês
    ) %>%
    summarize(`Num ASVs` = length(unique(`ASV (Sequence)`)),
              `Num OTUs` = length(unique(`OTU`)),
              `ID Abundance on sample (%)` = sum(`Relative abundance on sample`),
              `Ponto` = Point) %>%
    mutate(Sample = factor(Sample, levels = c("LI1-neo-mi",
                                              "L2_dez20",
                                              "L2_nov20",
                                              "L1_nov21",
                                              "L1_out21",
                                              "L2_out21",
                                              "L3_out21",
                                              "L4_out21",
                                              "L2_nov21",
                                              "L3_nov21",
                                              "L4_nov21"
    ))) %>%
    ungroup() %>%
    unique()
  
  ## Facetar por ponto 
  {
    print(alpha_plot_ponto <- alpha_tbl %>% 
            mutate(`Curated ID` = factor(`Curated ID`)) %>%
            ggplot(aes(x = Sample,
                       fill = Mês)) + ## preenchendo as cores por mes de coleta
            geom_bar(stat = "count", position = "stack") +
            guides(col = guide_legend(nrow = 6)) +
            xlab("Amostra") +
            ylab("Riqueza de espécies") +
            ggtitle(label = "Riqueza de espécies por amostra") +
            theme_bw(base_size = 16) +
            theme(legend.position = "bottom") +
            theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
            geom_text(stat='count', ## codigo que exibe dentro das barras a contagem
                      aes(label=..count..),
                      position = position_dodge(width = 0.9),
                      vjust = 1.4,
                      colour = "#ffffff", size = 6) +
            facet_grid2(cols = vars(Point), ##facetando por ponto
                        scales = "free_x",
                        axes = "all",
                        space = "free_x",
                        independent ='x') +
            scale_fill_manual(values = viridis::viridis(n=6)[c(2,5,1,4)]))
    
    ## Plotando
    ggsave(plot = alpha_plot_ponto, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/novembro/barplots/alpha_plot_ponto.pdf",
           device = "pdf", units = "cm", height = 15, width = 20, dpi = 600)
    }
  
  ## Facetar por Mes/ponto
  {
    print(alpha_plot_mes_ponto <- alpha_tbl %>% 
            mutate(`Curated ID` = factor(`Curated ID`)) %>% 
            ggplot(aes(x = Sample,
                       fill = Ponto)) + ## preenchendo as barras por mes de coleta
            geom_bar(stat = "count", position = "stack") +
            guides(col = guide_legend(nrow = 6)) +
            xlab("Amostra") +
            ylab("Riqueza de espécies") +
            ggtitle(label = "Riqueza de espécies por amostra") +
            theme_bw(base_size = 16) +
            theme(legend.position = "bottom") +
            theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
            geom_text(stat='count', ## codigo que exibe dentro das barras a contagem
                      aes(label=..count..),
                      position = position_dodge(width = 0.9),
                      vjust = 1.4,
                      colour = "#ffffff", size = 6) +
            facet_grid2(cols = vars(Mês), ##facetando por mes
                        scales = "free_x",
                        axes = "all",
                        space = "free_x",
                        independent ='x') +
            scale_fill_manual(values = viridis::viridis(n=10)[c(1,7,5,9)]))
    
    ## Plotando
    ggsave(plot = alpha_plot_mes_ponto, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/novembro/barplots/alpha_plot_mes_ponto.pdf",
           device = "pdf", units = "cm", height = 15, width = 20, dpi = 600)
  }
  
  ## Facetar por Mes
  {
    print(alpha_plot_mes_join <- alpha_tbl %>% 
            mutate(`Curated ID` = factor(`Curated ID`)) %>% 
            ggplot(aes(x = Mês,
                       fill = Ponto)) + ## preenchendo as barras por mes de coleta
            geom_bar(stat = "count", position = "stack") +
            guides(col = guide_legend(nrow = 6)) +
            xlab("Mês") +
            ylab("Riqueza de espécies") +
            ggtitle(label = "Riqueza de espécies por mês") +
            theme_bw(base_size = 16) +
            geom_text(stat = 'count', aes(label = ..count..), position = position_stack(vjust = 0.5), size = 4))
    
    ## Plotando
    ggsave(plot = alpha_plot_mes_join, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/novembro/barplots/alpha_plot_mes_join.pdf",
           device = "pdf", units = "cm", height = 15, width = 14, dpi = 600)
  }
  
  ## Ids por amostra
  {
    print(alpha_plot_id_sample <- alpha_tbl %>%
            mutate(`Curated ID` = factor(`Curated ID`)) %>% 
            ggplot(aes(x = Sample,
                       y = `ID Abundance on sample (%)`,
                       group = Sample,
                       fill = as.factor(`Curated ID`))) +
            ggtitle(label = "Espécies por amostra") +
            xlab("Amostra") +
            ylab("Proporção %") +
            guides(fill = guide_legend("Espécie")) + ## alterar o titulo da legenda
            geom_bar(stat = "identity", position = "stack") +
            scale_fill_manual(values = color2))
    
    
    ## Plotando
    ggsave(plot = alpha_plot_id_sample, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/novembro/barplots/alpha_plot_id_sample.pdf",
           device = "pdf", units = "cm", height = 15, width = 28, dpi = 600)
  }
  
}
  ## ASVs
{  
  ## Facetar por ponto
  {
    print(asv_plot_ponto <- alpha_tbl %>% 
            group_by(Sample,Point,Mês) %>%
            summarise(`Num ASVs`=sum(`Num ASVs`)) %>%
            ungroup() %>%
            ggplot(aes(x = Sample,
                       y = `Num ASVs`,
                       fill = Mês)) + ## preenchendo as cores por mes de coleta
            geom_bar(stat = "identity") +
            guides(col = guide_legend(nrow = 6)) +
            xlab("Amostra") +
            ylab("Número de ASVs") +
            ggtitle(label = "ASVs por amostra") +
            theme_bw(base_size = 16) +
            theme(legend.position = "bottom") +
            theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
            geom_text(stat='identity', ## labels dentro das barras
                      aes(label = `Num ASVs`),
                      position = position_dodge(width = 0.9),
                      vjust = 1.4,
                      colour = "#ffffff",
                      size = 6
            ) +
            facet_grid2(cols = vars(Point), ##facetando por ponto
                        scales = "free_x",
                        axes = "all",
                        space = "free_x",
                        independent ='x') +
            scale_fill_manual(values = viridis::viridis(n=6)[c(2,5,1,4)]))
    
    ## Plotando
    ggsave(plot = asv_plot_ponto, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/novembro/barplots/asv_plot_ponto.pdf",
           device = "pdf", units = "cm", height = 15, width = 20, dpi = 600)
    }
  
  ## Facetar por Mes/ponto
  {
    print(asv_plot_mes_ponto <- alpha_tbl %>% 
            group_by(Sample,Point,Mês) %>%
            summarise(`Num ASVs`=sum(`Num ASVs`)) %>%
            ungroup() %>% 
            ggplot(aes(x = Sample,
                       y = `Num ASVs`,
                       fill = Point)) +
            geom_bar(stat = "identity") +
            guides(col = guide_legend(nrow = 6)) +
            xlab("Amostra") +
            ylab("Número de ASVs") +
            ggtitle(label = "Número de ASVs por amostra") +
            theme_bw(base_size = 16) +
            theme(legend.position = "bottom") +
            theme(axis.text.x = element_text(angle = 45,hjust = 1)) +
            geom_text(stat='identity', ## codigo que exibe dentro das barras a contagem
                      aes(label=`Num ASVs`),
                      position = position_dodge(width = 0.9),
                      vjust = 1.4,
                      colour = "#ffffff", size = 6) +
            facet_grid2(cols = vars(Mês), ##facetando por mes
                        scales = "free_x",
                        axes = "all",
                        space = "free_x",
                        independent ='x') +
            scale_fill_manual(values = viridis::viridis(n=10)[c(1,7,5,9)]))
    
    ## Plotando
    ggsave(plot = asv_plot_mes_ponto, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/novembro/barplots/asv_plot_mes_ponto.pdf",
           device = "pdf", units = "cm", height = 15, width = 20, dpi = 600)
  }
  
  ## Facetar por Mes
  {
    print(asv_plot_mes_join <- alpha_tbl %>% 
            group_by(Sample,Point,Mês) %>%
            summarise(`Num ASVs`=sum(`Num ASVs`)) %>%
            ungroup() %>% 
            ggplot(aes(x = Mês,
                       y = `Num ASVs`,
                       fill = Point)) + ## preenchendo as barras por mes de coleta
            geom_bar(stat = "identity") +
            guides(col = guide_legend(nrow = 6)) +
            xlab("Mês") +
            ylab("Número de ASVs") +
            ggtitle(label = "Número de ASVs por mês") +
            theme_bw(base_size = 16) +
            geom_text(stat = 'identity',
                      aes(label = `Num ASVs`),
                      position = position_stack(vjust = 0.5),
                      size = 4))
    
    ## Plotando
    ggsave(plot = asv_plot_mes_join, filename = "/home/gabriel/projetos/lagoa_ingleses/results/figuras/novembro/barplots/asv_plot_mes_join.pdf",
           device = "pdf", units = "cm", height = 15, width = 14, dpi = 600)
  }
}
```

